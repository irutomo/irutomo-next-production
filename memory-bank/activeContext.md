# アクティブコンテキスト - irutomo222レストラン予約システム

## 現在の焦点

現在のプロジェクトの焦点は以下の通りです：

1. **Next.js 15.2への移行**:
   - ✅ プロジェクト構造をPages RouterからApp Routerに移行
   - ✅ Server Componentsとクライアントコンポーネントの適切な分離
   - ✅ Next.js 15.2の最新機能の活用（ストリーミングメタデータ、Turbopack、永続的キャッシュ）
   - ✅ React 19との互換性確保
   - Shadcn UIコンポーネントのApp Router対応
   - 実験的機能（React Compiler）の評価と適用検討

2. **認証フロー**:
   - ✅ Clerk-Supabase認証統合をJWTテンプレート方式からセッショントークン方式に完全移行
   - ✅ 古いJWT関連コードを非推奨化し、コードベースをクリーンアップ
   - ✅ 認証プロセスを簡素化し、エラー耐性を向上
   - ✅ Next.js App Routerのミドルウェアを活用した認証保護
   - ✅ Server Actionsでの安全な認証処理の実装
   - ✅ Supabaseセッション同期の最適化（キャッシュと最適化実装済み）

3. **PayPal統合**:
   - ✅ PayPal Sandbox環境でのセッション問題対策（クリアメカニズム実装）
   - ✅ PayPalデバッガーのローカル環境での改善（診断機能実装）
   - ✅ Server Actionsを使用した安全な決済処理
   - ✅ 支払いフローのエラーハンドリングの強化（リトライ機能実装）
   - ユーザー体験の向上（支払い処理中のフィードバック改善）
   - ✅ 公式React SDK (@paypal/react-paypal-js) の最適な利用
   - ✅ 通貨フォーマット機能の強化と国際化対応

4. **パフォーマンス最適化**:
   - ✅ ストリーミングメタデータの実装によるページロード速度の向上
   - ✅ 永続的キャッシュ機能の活用
   - ✅ 画像最適化（next/image）の適切な実装
   - ✅ Suspenseとストリーミングレスポンスの活用
   - ✅ バンドルサイズの最適化とコード分割
   - Turbopackによる開発環境の高速化
   - 部分的プリレンダリング（PPR）の検討

5. **セキュリティ強化**:
   - ✅ Next.js環境でのCSP設定の最適化
   - ✅ Server Actionsによる安全なデータ処理
   - ✅ 認証情報の安全な管理と伝送の確保
   - ✅ Content-Security-Policyの包括的設定
   - 環境変数管理の強化

## 最近の変更

1. **Next.js 15.2への移行**:
   - App Routerベースのプロジェクト構造への移行（2025年4月3日）
   - Server Componentsとクライアントコンポーネントの分離（2025年4月3日）
   - ルーティングシステムの再構築（2025年4月3日）
   - React 19との互換性確保（2025年4月3日）
   - Server Actionsを使用したフォーム処理の実装（2025年4月3日）
   - next/imageによる画像最適化の実装（2025年4月3日）

2. **認証システムの改善**:
   - App Routerミドルウェアを使用した認証フロー実装（2025年4月3日）
   - Server Componentsでの認証コンテキスト設定（2025年4月3日）
   - Clerk-Supabase認証の最新プラクティス適用（2025年4月3日）
   - 認証フローのエラーハンドリング強化（2025年4月3日）

3. **PayPal統合の強化**:
   - Server Actions内でのPayPal決済処理実装（2025年4月3日）
   - クライアントコンポーネント内でのPayPal UI最適化（2025年4月3日）
   - Server-Clientの適切な責任分離（2025年4月3日）

4. **UI/UX改善**:
   - Shadcn UIとTailwind CSSの導入（2025年4月3日）
   - Server ComponentsによるSSRの活用（2025年4月3日）
   - Suspenseによる段階的UI表示の実装（2025年4月3日）
   - 改善されたエラーUIの実装（2025年4月3日）

## 現在の問題点

1. **Next.js 15.2移行関連**:
   - いくつかの古いReact Router DOM依存コンポーネントの移行が未完了
   - Suspenseバウンダリの最適な配置の検討
   - 開発環境でのTurbopackパフォーマンスのさらなる最適化
   - React Compilerのエッジケースでの挙動確認

2. **PayPal Sandbox環境の問題**:
   - セッションの維持問題は改善したが、稀にタイムアウトが発生
   - サンドボックス環境特有の遅延問題への対応が必要

3. **認証関連の課題**:
   - トークンリフレッシュのさらなる最適化（バックグラウンドリフレッシュ）
   - セッション有効期限切れ時のUX改善が必要

4. **UI/UX課題**:
   - ストリーミングUIにおける累積レイアウトシフト（CLS）の最小化
   - 初期ロード時のスケルトンUIの改善
   - 支払い処理中のUIフィードバックをさらに改善

## 次のステップ

1. **Next.js 15.2機能の完全活用**:
   - Turbopackの本格導入
   - React Compilerの導入評価
   - 部分的プリレンダリング（PPR）の活用
   - ストリーミングメタデータの全ページ対応
   - Server Actionsの完全適用
   - next/fontによるフォント最適化

2. **認証システム**:
   - ✅ JWT関連のコードを完全に削除または非推奨化（完了）
   - ✅ セッショントークン方式への完全移行（完了）
   - ✅ トークン取得の最適化（キャッシュ機構実装完了）
   - バックグラウンドトークンリフレッシュの実装
   - ✅ Server Actionsでの安全な認証処理の完全実装

3. **PayPal統合**:
   - ✅ Server Actionsを使用した安全な決済処理（完了）
   - ✅ サンドボックスセッション問題の対策実装（完了）
   - エラーメッセージとユーザーフィードバックの改善
   - Server Components・Suspenseを活用した支払いUI改善

4. **パフォーマンス最適化**:
   - Web Vitalsの測定とモニタリング
   - コアウェブバイタルの最適化（LCP, FID, CLS）
   - Vercelアナリティクスの導入検討
   - 永続的キャッシュの最適化
   - 画像配信の最適化とCDN活用

5. **UI/UX向上**:
   - ログインモーダル表示問題の調査と修正
   - インターセプトルート活用によるモーダル実装
   - パラレルルートを使用したマルチビュー実装
   - アニメーションとトランジションの改善
   - アクセシビリティの向上

## 重要な決定事項

1. **フレームワーク移行**:
   - React + Vite + Express構成からNext.js 15.2への完全移行を決定
   - 理由: より効率的な開発体験、パフォーマンスの向上、最新のReact機能活用
   - 影響: コードベースの再構築、デプロイプロセスの変更、開発ワークフローの改善

2. **アーキテクチャパターン**:
   - Server ComponentsとClient Componentsの明確な責任分離
   - Server Actionsによるデータミューテーション処理
   - App Routerによるルーティング最適化
   - 理由: パフォーマンスの向上、UX改善、SEO最適化

3. **認証方式の変更**:
   - JWTテンプレート方式からセッショントークン方式への完全移行を実施
   - 理由: より効率的なトークン管理、セキュリティの向上、Clerkの最新ベストプラクティスへの準拠
   - 影響: 認証関連コードの簡素化、パフォーマンスの向上、将来的なメンテナンス性の改善

4. **デプロイ戦略の更新**:
   - CoreServerからVercelへの移行を検討
   - 理由: Next.jsとの統合の最適化、デプロイ自動化、分析ツールの活用
   - Vercelデプロイが困難な場合はCloudflare Pagesの検討

5. **UI技術選定の更新**:
   - カスタムUIからShadcn UIの採用
   - Tailwind CSSの活用
   - 理由: 開発効率の向上、一貫性あるデザイン、アクセシビリティ対応の強化

## 環境情報

- **開発環境**: Node.js 18.x, npm 9.x, Next.js 15.2, Supabase (ローカルまたはリモート)
- **テスト環境**: Vitest, Playwright, PayPal Sandbox
- **本番環境**: Vercel (推奨), オプションとしてCloudflare Pages, CoreServer 