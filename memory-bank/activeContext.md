# アクティブワークコンテキスト

## 現在の作業領域

### 認証システム
- ✅ 認証機能の簡素化実装完了
- 🔄 ページ遷移時の認証状態保持問題解決中 (80%)
- 🔄 インターセプトルートとログインモーダルの連携改善 (40%)

### レビュー機能
- ✅ レビュー表示UI実装
- ✅ レビュー一覧表示の最適化
- 🔄 レビュー投稿のServer Actions実装 (70%)
- 🔄 画像アップロード機能の完成 (60%)
- 🔄 レビュータグ選択状態の保持機能 (80%)
- 🔄 投稿後のUI/UXフロー最適化 (35%)
- ⚠️ 画像アップロード時にレビューフォームのリセット問題発生

### 検索機能
- ✅ 基本検索フィルター実装
- ✅ ソート機能（価格帯、評価、距離）完成
- ✅ 検索フィルター状態の保持機能実装
- 🔄 高度な検索API実装 (65%)
- 🔄 位置情報を活用した近隣レストラン検索 (30%)
- 🔄 詳細フィルタリングオプションの拡充 (60%)
- 🔄 検索結果のパフォーマンス最適化 (50%)

### UI/UX改善
- ✅ モバイル表示の基本的な最適化
- ✅ ダークモード対応完了
- ✅ アクセシビリティの基本対応（ARIA属性、キーボードナビゲーション）
- ✅ Suspenseを活用したローディング体験改善
- 🔄 インターセプトルートを活用したモーダル実装 (40%)
- 🔄 アニメーションとトランジションの改善 (30%)
- 🔄 モバイル最適化の完成 (85%)
- ⚠️ ログインモーダル表示問題が報告されている

### パフォーマンス最適化
- ✅ 画像最適化（next/image活用）
- ✅ コンポーネント遅延ロード戦略の実装
- 🔄 Web Vitalsの測定とモニタリング (50%)
- 🔄 CLSの最小化対策 (35%)
- 🔄 バンドルサイズの最適化 (75%)
- 🔄 レンダリングパフォーマンスの最適化 (40%)

### ヘッドレスCMS (Strapi) 連携
- ✅ StrapiクライアントAPI実装
- ✅ 日本情報ページとStrapiとの連携（データ統合）
- 🔄 Strapi管理画面でのコンテンツタイプ作成 (30%)
- 🔄 Railway上でのStrapiデプロイ最適化 (40%)
- ⚠️ Railway上でのStrapi開発モード起動の問題
- 🔄 ヘルスチェック問題の解決 (30%)

## 最近の技術的変更

1. **認証システム**
   - 認証システムの簡素化
   - 外部認証プロバイダーの除去
   - Cookieベースのセッション管理

2. **フレームワーク**
   - Next.js 15.3.0へのアップグレード（package.jsonで確認済み）
   - React 19.0.0の採用（package.jsonで確認済み）

3. **支払い処理**
   - PayPal SDKのバージョンアップデート (@paypal/react-paypal-js 8.8.2)
   - 決済エラーハンドリングの改善
   - 決済処理中の状態保存機能追加

4. **データベース**
   - Supabaseのスキーマ最適化
   - レビューテーブルに新しいインデックス追加
   - 検索クエリの最適化

5. **UI/UXライブラリ**
   - Radix UIコンポーネントの導入
   - Tailwind CSS設定の最適化
   - アニメーションライブラリの統合（Framer Motion 12.6.3）

6. **PayPal決済処理のエラーハンドリング強化**:
   - PayPal支払い完了後のデータベース保存エラー（RLSポリシー違反）を修正
   - サービスロールキーを使用したRLSバイパス実装
   - SUPABASE_SERVICE_ROLE_KEY環境変数の追加と活用
   - エラーハンドリングの改善と詳細なエラーログ追加
   - RLSポリシー違反時の明確なエラーメッセージ表示実装

7. **Strapi CMSとの連携**:
   - StrapiクライアントAPIの実装
   - 日本情報ページでのSupabase/Strapiデータ統合
   - Railway上でのStrapiデプロイ
   - Railway CLIによるStrapiサービス管理の習得

## 最近の作業

### 決済処理の改善
- PayPalの支払い完了後、RLSポリシーのためにデータベース保存処理が失敗する問題を解決
- サービスロールキーを使用してRLSをバイパスする実装を追加
- 環境変数`SUPABASE_SERVICE_ROLE_KEY`を追加して安全に管理
- エラーハンドリングを強化し、詳細なログを出力するよう改善

### Strapi CMS連携
- StrapiクライアントAPIを`lib/strapi/client.ts`に実装
- 日本情報ページ(`app/japan-info/page.tsx`)にStrapiから取得したデータを統合
- 日本情報詳細ページ(`app/japan-info/[id]/page.tsx`)にStrapiから取得したデータを統合
- Railway上にStrapiサービスをデプロイし、環境変数を設定
- 本番環境(`NODE_ENV=production`)でStrapiが正常に動作することを確認
- Railway CLI管理方法を習得し、コマンドラインからのサービス操作を実施

### Railwayヘルスチェック問題の調査
- Strapiの開発モードをRailway上で実行すると直後にコンテナが停止する問題を調査
- `railway logs --service Strapi`コマンドでログを確認し、Strapi自体は正常に起動していることを確認
- 原因はRailwayのヘルスチェックにあると推定
  - Strapiはルートパス(/)で302 Foundレスポンスを返すが、Railwayのヘルスチェックは200 OKを期待している
  - コンテナが起動して直後に「Stopping Container」ログが表示される
- 解決策を検討中:
  - Railwayダッシュボードでヘルスチェック設定パスの変更（優先検討）
  - または、Strapi側に常に `200 OK` を返す専用のヘルスチェックエンドポイントを作成する（代替案）
  
## 現在の課題

### 技術的課題
1. **レビュー投稿機能**
   - 問題: 画像アップロード中にフォーム状態がリセットされる
   - 原因: Server Actionsとクライアント側状態管理の連携問題
   - 対応: useTransitionとFormDataの適切な処理が必要

2. **ログインモーダル表示問題**
   - 問題: インターセプトルートでのモーダル表示後に認証状態が正しく反映されない
   - 原因: インターセプトルートと認証状態の同期の問題
   - 対応: モーダルクローズ時の状態更新処理の見直し

3. **パフォーマンス問題**
   - 問題: レストラン一覧表示時に画像読み込みによるCLSが発生
   - 原因: 画像サイズの事前指定が不十分
   - 対応: 画像コンポーネントの改善とサイズ指定の徹底

4. **モバイル対応**
   - 問題: 一部画面でのレイアウト崩れ
   - 原因: フレックスボックスの振る舞いがデバイスによって異なる
   - 対応: レスポンシブデザインの見直しとメディアクエリの最適化

5. **Supabase連携の最適化**
   - 問題: Server Actions内でのRLSポリシー制約
   - 原因: サービスロールキーの適切な管理と使用範囲の明確化が必要
   - 対応: サービスロールキーを使用するヘルパー関数の整備

6. **Railway上でのStrapi開発モード問題**
   - 問題: Strapi管理画面でコンテンツタイプを編集するには開発モード(`NODE_ENV=development`)が必要だが、Railway上でStrapiを開発モードで起動すると直後にコンテナが停止する
   - 原因: Railwayのヘルスチェックに失敗している。Strapiのルートパス(`/`)が `302 Found` (リダイレクト) を返すため、ヘルスチェックが失敗している
   - 対応: 
     - Railwayのダッシュボードでヘルスチェック設定を確認し変更する（パス、期待するステータスコードなど）（優先）
     - または、Strapi側に常に `200 OK` を返す専用のヘルスチェックエンドポイントを作成する（代替案）
   - 現状:
     - `railway variables`コマンドで環境変数確認済み
     - Strapiは現在本番モード(`NODE_ENV=production`)で稼働中
     - Railwayダッシュボードでのヘルスチェック設定変更を検討中

### プロジェクト管理上の課題
1. **スコープクリープ**
   - 予約機能の拡張要望が増えている
   - 現状のスコープ内で優先順位を明確にする必要がある

2. **リソース配分**
   - フロントエンド開発に重点が置かれ、バックエンド最適化が遅れている
   - チーム編成の見直しを検討中

## 次のステップ

### 短期目標（2週間以内）
1. レビュー投稿機能の完成（担当: フロントエンドチーム、期限: 6/15）
   - 画像アップロード問題の解決
   - 投稿後のUXフローの最適化
   - バリデーションの強化

2. ログインモーダル問題の解決（担当: 認証チーム、期限: 6/10）
   - インターセプトルートとの連携改善
   - 状態同期メカニズムの実装
   - エッジケースのテスト

3. パフォーマンス最適化第一フェーズ（担当: パフォーマンスチーム、期限: 6/20）
   - CLS問題の解決
   - 初期ロード時間の改善
   - バンドルサイズの最適化完了

4. Railway上のStrapi開発モード問題の解決（担当: バックエンドチーム、期限: 6/5）
   - Railwayダッシュボードでヘルスチェック設定の確認と調整（優先）
     - ヘルスチェックパスの変更 ("/admin" や "/admin/login" など200を返すパスに)
     - または期待するレスポンスコードを302に変更
   - 代替案: Strapiに専用のヘルスチェックエンドポイント実装
   - 開発モードでStrapiを起動し、コンテンツタイプ「japan-info-articles」の作成

### 中期目標（1ヶ月以内）
1. 高度な検索機能の完成（担当: 検索チーム、期限: 7/5）
   - 位置情報検索の完成
   - 複合フィルターの最適化
   - 検索結果のパフォーマンス改善

2. 通知システムの強化（担当: バックエンドチーム、期限: 7/15）
   - リアルタイム通知の実装
   - 通知設定の詳細カスタマイズ機能
   - プッシュ通知の検討

3. E2Eテストの拡充（担当: QAチーム、期限: 7/20）
   - 主要ユーザーフローのテスト自動化
   - エッジケースのテスト強化
   - パフォーマンステストの統合

4. 他の決済サービス（クレジットカード直接決済など）の統合検討
- バックエンドでのトランザクション処理の強化

5. Strapiコンテンツ管理の完全統合（担当: バックエンドチーム、期限: 7/10）
   - すべての日本情報記事をStrapiで管理できるよう移行
   - 画像管理機能の強化
   - 多言語コンテンツの効率的な編集ワークフロー確立

## 重要な決定事項

1. **認証システム**
   - シンプルな認証システムを採用
   - セキュアなCookieベースのセッション管理
   - セキュリティ強化のため、CSRFトークンを全フォームに導入する

2. **デプロイ戦略**
   - 継続的デプロイを採用し、主要な機能ごとにプレビューデプロイを行う
   - A/Bテスト機能の導入を準備する
   - 本番環境へのデプロイ前に自動パフォーマンステストを実施する

3. **パフォーマンス**
   - Core Web Vitalsのすべての指標でグリーンを目指す
   - 初期ロード時間を1.5秒以下に最適化する
   - バンドルサイズを最小限に抑えるためのコード分割戦略を採用する

4. **UI/UX**
   - モバイルファーストのデザイン原則を徹底する
   - アクセシビリティに関するWCAGレベルAAの準拠を目指す
   - デザインシステムを段階的に構築し、コンポーネントの再利用性を高める

5. **コンテンツ管理**
   - Strapiをヘッドレスデザインと位置づけ、主要なコンテンツ管理にも使用する
   - 多言語コンテンツの効率的な管理を可能にする
   - 画像やメディア管理も一元化する

6. **Railway上のStrapi管理**
   - Railway CLIを使用した管理を標準とし、環境変数設定や再デプロイを効率化
   - ヘルスチェック設定をRailwayダッシュボードから最適化する
   - 必要に応じてStrapiカスタマイズも検討する

## プロジェクト状況

### 全体進捗
- フロントエンド: 85% 完了
- バックエンド: 82% 完了
- インフラ: 75% 完了
- テスト: 70% 完了
- 運用準備: 65% 完了
- コンテンツ管理: 50% 完了
- **総合: 78% 完了**

### 優先タスク
1. レビュー投稿機能のバグ修正 (最優先)
2. ログインモーダル問題の解決 (高)
3. CLS最適化 (高)
4. 位置情報検索機能の完成 (中)
5. バンドルサイズの最適化 (中)
6. Railway上のStrapi開発モード問題解決 (高)

## 技術スタック

### フロントエンド
- Next.js 15.3.0
- React 19.0.0
- TypeScript 5.4.5
- Tailwind CSS 3.4.1
- Radix UI
- Framer Motion 12.6.3 (アニメーション)

### バックエンド
- Next.js Server Actions
- Server Components
- Edge API Routes
- Strapi 4.15.5 (ヘッドレスCMS)

### データベース
- Supabase 2.49.4 (PostgreSQL)
- Redis (キャッシュ)

### インフラ
- Vercel (Next.jsホスティング)
- Railway (Strapiホスティング)
- Cloudinary (画像ストレージ)
- Sentry (エラー監視)
- GitHub Actions (CI/CD)

### テスト
- Vitest 1.3.1 (単体テスト)
- Playwright (E2E)
- Lighthouse (パフォーマンス)

## ユーザーフロー最適化ポイント

1. **レストラン検索から予約まで**
   - 検索結果表示の高速化
   - 詳細ページへのスムーズな遷移
   - 予約フォームの使いやすさ改善

2. **ユーザー登録から初回予約まで**
   - 登録フローのステップ最適化
   - 必要最小限の情報入力
   - ガイド付きツアーの検討

3. **レビュー投稿フロー**
   - 予約履歴からのスムーズな誘導
   - 投稿ハードルの低減
   - ソーシャル共有機能の検討

## コード健全性メトリクス

1. **テストカバレッジ**
   - ユニットテスト: 78%
   - 統合テスト: 65%
   - E2Eテスト: 60%

2. **パフォーマンス**
   - FCP (First Contentful Paint): 1.2秒
   - LCP (Largest Contentful Paint): 2.4秒
   - CLS (Cumulative Layout Shift): 0.25
   - TTI (Time to Interactive): 3.2秒

3. **コード品質**
   - ESLintエラー: 0
   - ESLint警告: 15
   - TypeScript型カバレッジ: 92%
   - コンポーネントドキュメント: 60%