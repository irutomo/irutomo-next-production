# コアサーバーへのデプロイ手順

このドキュメントでは、IRUTOMOアプリケーションをコアサーバーにデプロイする手順を説明します。

## 前提条件

- コアサーバーのFTPアクセス情報
- Node.jsとnpmがインストールされていること

## デプロイ手順

### 1. ビルドとデプロイファイルの作成

提供されているデプロイスクリプトを使用して、ビルドとデプロイファイルを作成します。

```bash
# プロジェクトのルートディレクトリで実行
./deployment/coreserver/deploy.sh
```

このスクリプトは以下の処理を行います：

- 環境変数の設定
- Next.jsの設定の調整
- ビルドの実行
- 必要なファイルのコピー

### 2. コアサーバーへのアップロード

FTPクライアントを使用して、生成されたファイルをコアサーバーにアップロードします。

1. FTPクライアント（FileZilla、Cyberduckなど）を起動
2. コアサーバーに接続
3. ビルドされたファイル（`deployment/coreserver/out/`内のすべてのファイル）を、Webサイトのルートディレクトリにアップロード

### 3. ファイルのパーミッションの確認

以下のファイルとディレクトリに適切なパーミッションが設定されていることを確認します：

- `.htaccess` - 644（rw-r--r--）
- `api/` ディレクトリ - 755（rwxr-xr-x）
- `api/fallback.php` - 644（rw-r--r--）

### 4. 動作確認

ブラウザでWebサイト（https://irutomo-trip.com/）にアクセスし、以下の点を確認します：

- トップページが正しく表示されるか
- 画像やスタイルが正しく読み込まれているか
- 各ページへの遷移が正しく動作するか

## トラブルシューティング

### 404エラーが発生する場合

`.htaccess`ファイルが正しくアップロードされているか、また、サーバーで`.htaccess`ファイルが有効になっているか確認してください。

### 画像が表示されない場合

画像パスが正しく設定されているか確認してください。本番環境のURLを使用しているか確認します。

### API関連のエラーが発生する場合

APIエンドポイントへのリクエストが`api/fallback.php`にリダイレクトされているか確認してください。

## 注意事項

- 本番環境では、APIエンドポイント（`/api/auth/supabase-token`や`/api/webhook/clerk`）は静的なフォールバックになっています。これらのエンドポイントを利用する機能は制限されます。
- 認証が必要な機能は、サーバーサイド機能が必要なため、静的ホスティングでは完全には動作しません。
- 実際の本番環境では、これらの制限を解消するために、サーバーサイドの機能を持つホスティングサービスへの移行を検討してください。

## 今後の改善点

- サーバーレス関数をサポートするホスティングプラットフォームへの移行
- クライアントサイドでの認証処理の最適化
- APIエンドポイントのモック対応の強化 