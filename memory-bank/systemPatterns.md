# システムパターン - irutomo222レストラン予約システム

## アーキテクチャ概要

irutomo222レストラン予約システムは、Next.js 15.2を基盤としたモダンなWebアプリケーションです。App Routerモデルを採用し、React Server Componentsとクライアントコンポーネントを効果的に組み合わせてパフォーマンスとユーザー体験を最適化しています。

### アーキテクチャモデル
- **フレームワーク**: Next.js 15.2, React 19
- **UI**: React Server Components, クライアントコンポーネント
- **データ層**: Supabase (PostgreSQL)
- **外部サービス**: Clerk (認証), PayPal (決済), Channel.io (サポート)

## フロントエンドパターン

### ディレクトリ構造とファイル規約
1. **App Routerディレクトリ構造**
   - `app/` - App Routerのルートディレクトリ
   - `app/layout.tsx` - ルートレイアウト
   - `app/page.tsx` - ホームページ
   - `app/(routes)/[...]` - 各種ルート
   - `app/api/[...]` - APIルート
   - `app/[locale]/[...]` - 多言語サポート

2. **コンポーネント構造**
   - `components/` - 共通コンポーネント
   - `components/ui/` - 基本UI要素（Shadcn UI）
   - `components/[feature]/` - 機能別コンポーネント
   - `lib/` - ユーティリティ関数
   - `hooks/` - カスタムフック
   - `types/` - TypeScript型定義

3. **命名規約**
   - ファイル名: kebab-case (例: `reservation-form.tsx`)
   - コンポーネント名: PascalCase (例: `ReservationForm`)
   - フック名: camelCase + use接頭辞 (例: `useReservation`)
   - ユーティリティ関数: camelCase (例: `formatCurrency`)

### コンポーネント設計パターン
1. **Server/Client分離パターン**
   - `page.tsx` (Server Component) - データフェッチング、SEO、初期レンダリング
   - `*.client.tsx` - インタラクティブなクライアント側機能
   - `.tsx` (デフォルトServer Component) - UI表示、データレンダリング
   - `use client` - クライアントコンポーネントのマーカー

2. **Atomicデザイン（部分的に採用）**
   - `ui/button.tsx`, `ui/input.tsx` - 基本要素
   - `ui/form.tsx`, `ui/card.tsx` - 複合要素
   - `components/header.tsx`, `components/footer.tsx` - 複雑なコンポーネント
   - `app/[route]/layout.tsx` - ページレイアウト

3. **React Server Components (RSC) パターン**
   - データフェッチングを含むコンポーネント
   - SEO関連機能と静的コンテンツレンダリング
   - プロップドリリングの回避
   - サーバーサイド限定のAPIやデータへのアクセス

4. **クライアントコンポーネントパターン**
   - ユーザーインタラクション（フォーム、ボタンなど）
   - ステート管理が必要なUI要素
   - ブラウザAPIを使用する機能
   - useEffectやEventHandlerを必要とする要素

5. **パラレルルートとインターセプトルート**
   - 複数のビューを同時に表示するパラレルルート
   - モーダルやスライドオーバーのためのインターセプトルート
   - ナビゲーションの中断なしのUI表示

### データフェッチングパターン
1. **Server Componentsでのデータフェッチ**
   - コンポーネント内での直接fetch
   - APIハンドラー関数のインポート
   - データベースクライアントの直接利用
   - 並列データフェッチ

2. **TanStack Query (クライアント側)**
   - リアルタイムデータの取得と更新
   - キャッシュ管理と再検証
   - 楽観的UI更新
   - エラー処理とリトライ

3. **サーバーアクション**
   - クライアントからサーバー関数を直接呼び出し
   - フォーム処理とデータミューテーション
   - 楽観的更新とサーバー検証
   - TypeScript型安全性の維持

### レンダリングとパフォーマンスパターン
1. **ストリーミングとSuspense**
   - 段階的UIローディング
   - コンテンツストリーミング
   - ローディング状態のカスタマイズ
   - Suspenseバウンダリの効果的な配置

2. **プログレッシブエンハンスメント**
   - 基本機能のサーバーレンダリング
   - JavaScript無効時の基本機能維持
   - クライアント側での機能強化

3. **メタデータの最適化**
   - 静的メタデータとdynamic generateMetadata
   - ストリーミングメタデータによるパフォーマンス向上
   - SEO対応のメタデータ自動生成

4. **画像最適化**
   - next/imageによる自動最適化
   - WebPフォーマットの利用
   - 遅延ロードと優先順位付け
   - 適切なサイズと品質の選択

5. **部分的プリレンダリング (PPR)**
   - 静的部分の事前レンダリング
   - 動的部分のストリーミング
   - キャッシュ戦略の最適化

## バックエンドパターン

### APIルート設計
1. **ルートハンドラー**
   - `app/api/[...]/route.ts` - REST API実装
   - HTTPメソッド対応関数 (GET, POST, PUT, DELETE)
   - Next.js Response/Request APIの活用
   - エラーハンドリングとステータスコード

2. **バージョニング戦略**
   - `/api/v1/[リソース]` - API版数管理
   - 下位互換性の維持
   - 非推奨APIの段階的廃止

3. **ミドルウェア適用**
   - `middleware.ts` - グローバルミドルウェア
   - ルート保護と認証チェック
   - レート制限とスロットリング
   - リクエスト/レスポンス変換

### 認証パターン
1. **Clerk認証システム**
   - ✅ セッションベース認証（JWTベースから移行）
   - ✅ Next.js App Routerとの統合
   - ✅ ミドルウェアによる認証保護
   - ✅ 多要素認証対応
   - ✅ ソーシャルログイン

2. **Clerk-Supabase連携**
   - ✅ セッショントークン認証（従来のJWTテンプレート方式から移行）
     - 2025年4月1日より、JWTテンプレート方式は公式に非推奨化
   - ✅ ClerkダッシュボードのConnect with Supabase機能を使用
   - ✅ Supabaseダッシュボードでのサードパーティ認証設定
   - ✅ Server Actionsでの認証フロー
   - ✅ 型安全なセッション管理
   - ✅ Supabase RLS (Row Level Security)
   - ✅ クライアントサイドでのSupabase認証状態同期

3. **認可**
   - ✅ ロールベースアクセス制御
   - ✅ ポリシーベースのデータアクセス
   - ✅ 機能フラグによる機能の有効化/無効化
   - ✅ ミドルウェアによるルート保護

### エラーハンドリングパターン
1. **Next.js エラーハンドリング**
   - `error.tsx` - ルート別エラーUI
   - `not-found.tsx` - 404カスタム表示
   - `global-error.tsx` - グローバルエラー
   - React Error Boundaryの活用

2. **カスタムエラークラス**
   - ✅ `ApiError`, `ValidationError`, `AuthenticationError`など
   - ✅ エラータイプ、コード、メッセージを含む
   - ✅ スタックトレース保持
   - ✅ 追加メタデータサポート

3. **Try/Catchとサーバーアクション**
   - ✅ サーバーアクション内でのエラーキャプチャ
   - ✅ クライアント側へのエラー伝播
   - ✅ 自動リトライメカニズム
   - ✅ タイムアウト処理

## データベース設計パターン

### スキーマ設計
1. **正規化**
   - 3NF（第三正規形）までのデータ正規化
   - 外部キー制約
   - カスケード更新/削除

2. **インデックス戦略**
   - 検索/フィルタリングフィールドへのインデックス付与
   - 複合インデックス
   - パフォーマンス最適化

3. **テーブル設計パターン**
   - `created_at`, `updated_at` タイムスタンプ
   - 論理削除（ソフトデリート）
   - バージョン履歴

### RLS（Row Level Security）パターン
1. **ユーザーベースのアクセス制御**
   - ユーザーIDに基づくデータフィルタリング
   - ロールベースの権限制御

2. **複雑なポリシー**
   - 複数条件を組み合わせたアクセス制御
   - 時間ベースのアクセス制限
   - 関係ベースのポリシー

## 統合パターン

### API設計パターン
1. **RESTful設計**
   - 資源指向のURLパス
   - HTTPメソッドの適切な使用
   - ステータスコードの一貫した使用

2. **レスポンス構造**
   - 標準化されたレスポンス形式
   - メタデータとペイロードの分離
   - エラー情報の一貫した形式

### 外部サービス統合
1. **SDKベースの統合**
   - ✅ PayPal SDK (@paypal/react-paypal-js)
   - ✅ Clerk SDK

2. **Server Actions活用**
   - ✅ サーバー側で安全なAPI呼び出し
   - ✅ APIキーの保護
   - ✅ エラーハンドリングとリトライ

3. **ウェブフック処理**
   - ✅ APIルートを使用したウェブフック受信
   - ✅ イベント検証と処理
   - ✅ 非同期処理と応答分離

### PayPal統合パターン
1. **PayPal SDKラッパー**
   - ✅ 公式React SDK適用
   - ✅ コンポーネント抽象化
   - ✅ 設定の一元管理

2. **セッション管理最適化**
   - ✅ サンドボックス環境問題対策
   - ✅ ストレージクリーンアップ
   - ✅ クッキー管理の改善

3. **決済フロー実装**
   - ✅ Server Actionsを使用した安全な処理
   - ✅ トランザクション管理
   - ✅ エラー処理と再試行

4. **診断ツール**
   - ✅ サンドボックスデバッガー
   - ✅ トラブルシューティング支援
   - ✅ 状態監視と診断

5. **国際化対応**
   - ✅ 多通貨サポート
   - ✅ ロケール別表示
   - ✅ 金額フォーマット

## 開発環境パターン

### 開発サーバー構成
1. **Next.js Development Server**
   - HMR (Hot Module Replacement)
   - ファストリフレッシュ
   - 開発者ツール
   - エラーオーバーレイ

2. **Turbopack活用**
   - 高速開発サーバー
   - メモリ使用量最適化
   - インクリメンタルビルド
   - タイプセーフなHMR

### 環境変数管理
1. **環境別の設定**
   - 開発、テスト、本番環境の分離
   - `.env.local`, `.env.development`, `.env.production`

2. **型安全な環境変数**
   - 型定義によるIntelliSense対応
   - 検証によるエラー早期発見

## セキュリティパターン

### 認証・認可
1. **Clerk認証ベストプラクティス**
   - ✅ セッショントークン方式（より効率的でセキュアなアプローチ）
     - 2025年4月1日よりSupabase公式に推奨
     - 従来のJWTテンプレート方式は2026年1月まではサポート継続
   - ✅ 古いJWT方式の完全廃止
   - ✅ 多要素認証対応
   - ✅ ソーシャルログイン

2. **トークン管理**
   - ✅ セキュアなトークン保存
   - ✅ トークン有効期限とリフレッシュロジック
   - ✅ トークンのセキュアな伝送
   - ✅ 自動トークン更新メカニズム
   - ✅ トークンキャッシュとパフォーマンス最適化

### データ保護
1. **入力検証**
   - サーバーサイドとクライアントサイドの両方でのバリデーション
   - Server Actionsでの検証
   - Zodによる型安全なバリデーション
   - XSS対策のためのHTMLエスケープ

2. **HTTPセキュリティヘッダー**
   - CSP (Content Security Policy)
     - ✅ Next.js設定による実装
     - ✅ 最適化されたドメイン設定
     - ✅ PayPal SDKの完全対応
     - ✅ Clerk認証対応
     - ✅ Web Workerとblobスキームの適切な設定
   - HSTS (HTTP Strict Transport Security)
   - Middlewareによるセキュリティヘッダー適用

3. **決済セキュリティ**
   - ✅ Server Actionsでの安全な処理
   - ✅ 決済トランザクションの整合性確保
   - ✅ エラー耐性とリトライメカニズム
   - ✅ セッション管理の最適化

## デザインパターン

### クライアントサイド
1. **カスタムフック**
   - 再利用可能なロジックのカプセル化
   - 例: `useAuth`, `useReservation`, `usePayment`

2. **コンポーネント合成**
   - 小さな単一責任コンポーネントの組み合わせ
   - プロップによる設定とカスタマイズ
   - 例: `<Form><FormField><Input /></FormField></Form>`

3. **コンテキストプロバイダー**
   - アプリケーション状態の共有
   - 例: `<ThemeProvider>`, `<AuthProvider>`

### サーバーサイド
1. **Server Action Handlers**
   - フォーム処理とデータミューテーション
   - 入力検証と型安全性
   - エラーハンドリングと結果返却

2. **Route Handlers**
   - APIエンドポイント実装
   - リクエスト処理とレスポンス生成
   - ミドルウェア適用

3. **サービスパターン**
   - ビジネスロジックのカプセル化
   - 再利用可能なデータ操作関数
   - Server ComponentとServer Actionsからの呼び出し

## テストパターン

### フロントエンドテスト
1. **コンポーネントテスト**
   - Vitest + Testing Libraryを使用
   - ユーザーインタラクションのシミュレーション
   - アクセシビリティテスト

2. **統合テスト**
   - ページレベルのテスト
   - 複数コンポーネントの連携テスト

3. **E2Eテスト**
   - Playwrightによるブラウザ自動化
   - ユーザーフローの完全なテスト
   - マルチブラウザテスト

### バックエンドテスト
1. **単体テスト**
   - サービスとヘルパー関数のテスト
   - モックとスタブの使用

2. **APIテスト**
   - エンドポイントの機能テスト
   - リクエスト/レスポンスの検証

3. **データベーステスト**
   - クエリとデータ操作のテスト
   - トランザクションのテスト

## デプロイメントパターン

1. **ビルドプロセス**
   - Next.js buildによる最適化ビルド
   - 環境変数の挿入
   - アセット最適化

2. **デプロイ戦略**
   - Vercel連携によるCI/CD（推奨）
   - GitHub Actions自動デプロイ
   - 環境別の設定と検証 