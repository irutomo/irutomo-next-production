# システムパターン - irutomo222レストラン予約システム

## アーキテクチャ概要

irutomo222レストラン予約システムは、Next.js 15.2を基盤としたモダンなWebアプリケーションです。App Routerモデルを採用し、React Server Componentsとクライアントコンポーネントを効果的に組み合わせてパフォーマンスとユーザー体験を最適化しています。

### アーキテクチャモデル
- **フレームワーク**: Next.js 15.2, React 19
- **UI**: React Server Components, クライアントコンポーネント
- **データ層**: Supabase (PostgreSQL)
- **外部サービス**: Clerk (認証), PayPal (決済), Channel.io (サポート)

## フロントエンドパターン

### ディレクトリ構造とファイル規約
1. **App Routerディレクトリ構造**
   - `app/` - App Routerのルートディレクトリ
   - `app/layout.tsx` - ルートレイアウト
   - `app/page.tsx` - ホームページ
   - `app/(routes)/[...]` - 各種ルート
   - `app/api/[...]` - APIルート
   - `app/[locale]/[...]` - 多言語サポート
   - `app/reviews/` - レビュー一覧ページ
   - `app/write-review/` - レビュー投稿ページ
   - `app/service/` - サービス紹介ページ

2. **コンポーネント構造**
   - `components/` - 共通コンポーネント
   - `components/ui/` - 基本UI要素（Shadcn UI）
   - `components/[feature]/` - 機能別コンポーネント
   - `lib/` - ユーティリティ関数
   - `hooks/` - カスタムフック
   - `types/` - TypeScript型定義

3. **命名規約**
   - ファイル名: kebab-case (例: `reservation-form.tsx`)
   - コンポーネント名: PascalCase (例: `ReservationForm`)
   - フック名: camelCase + use接頭辞 (例: `useReservation`)
   - ユーティリティ関数: camelCase (例: `formatCurrency`)

### コンポーネント設計パターン
1. **Server/Client分離パターン**
   - `page.tsx` (Server Component) - データフェッチング、SEO、初期レンダリング
   - `*.client.tsx` - インタラクティブなクライアント側機能
   - `.tsx` (デフォルトServer Component) - UI表示、データレンダリング
   - `use client` - クライアントコンポーネントのマーカー

2. **Atomicデザイン（部分的に採用）**
   - `ui/button.tsx`, `ui/input.tsx` - 基本要素
   - `ui/form.tsx`, `ui/card.tsx` - 複合要素
   - `components/header.tsx`, `components/footer.tsx` - 複雑なコンポーネント
   - `app/[route]/layout.tsx` - ページレイアウト

3. **React Server Components (RSC) パターン**
   - データフェッチングを含むコンポーネント
   - SEO関連機能と静的コンテンツレンダリング
   - プロップドリリングの回避
   - サーバーサイド限定のAPIやデータへのアクセス

4. **クライアントコンポーネントパターン**
   - ユーザーインタラクション（フォーム、ボタンなど）
   - ステート管理が必要なUI要素
   - ブラウザAPIを使用する機能
   - useEffectやEventHandlerを必要とする要素

5. **パラレルルートとインターセプトルート**
   - 複数のビューを同時に表示するパラレルルート
   - モーダルやスライドオーバーのためのインターセプトルート
   - ナビゲーションの中断なしのUI表示

6. **セクションコンポーネントパターン**
   - ページをセクション別コンポーネントに分割
   - 例: `HeroSection`, `FeaturesSection`, `ReviewsSection`
   - 再利用可能で独立したセクション設計
   - 読み込み順序の最適化

### データフェッチングパターン
1. **Server Componentsでのデータフェッチ**
   - コンポーネント内での直接fetch
   - APIハンドラー関数のインポート
   - データベースクライアントの直接利用
   - 並列データフェッチ

2. **TanStack Query (クライアント側)**
   - リアルタイムデータの取得と更新
   - キャッシュ管理と再検証
   - 楽観的UI更新
   - エラー処理とリトライ

3. **サーバーアクション**
   - クライアントからサーバー関数を直接呼び出し
   - フォーム処理とデータミューテーション
   - 楽観的更新とサーバー検証
   - TypeScript型安全性の維持

### レンダリングとパフォーマンスパターン
1. **ストリーミングとSuspense**
   - 段階的UIローディング
   - コンテンツストリーミング
   - ローディング状態のカスタマイズ
   - Suspenseバウンダリの効果的な配置

2. **プログレッシブエンハンスメント**
   - 基本機能のサーバーレンダリング
   - JavaScript無効時の基本機能維持
   - クライアント側での機能強化

3. **メタデータの最適化**
   - 静的メタデータとdynamic generateMetadata
   - ストリーミングメタデータによるパフォーマンス向上
   - SEO対応のメタデータ自動生成

4. **画像最適化**
   - next/imageによる自動最適化
   - WebPフォーマットの利用
   - 遅延ロードと優先順位付け
   - 適切なサイズと品質の選択

5. **部分的プリレンダリング (PPR)**
   - 静的部分の事前レンダリング
   - 動的部分のストリーミング
   - キャッシュ戦略の最適化

## バックエンドパターン

### APIルート設計
1. **ルートハンドラー**
   - `app/api/[...]/route.ts` - REST API実装
   - HTTPメソッド対応関数 (GET, POST, PUT, DELETE)
   - Next.js Response/Request APIの活用
   - エラーハンドリングとステータスコード

2. **バージョニング戦略**
   - `/api/v1/[リソース]` - API版数管理
   - 下位互換性の維持
   - 非推奨APIの段階的廃止

3. **ミドルウェア適用**
   - `middleware.ts` - グローバルミドルウェア
   - ルート保護と認証チェック
   - レート制限とスロットリング
   - リクエスト/レスポンス変換

### 認証パターン
1. **Clerk認証システム**
   - ✅ セッションベース認証（JWTベースから移行）
   - ✅ Next.js App Routerとの統合
   - ✅ ミドルウェアによる認証保護
   - ✅ 多要素認証対応
   - ✅ ソーシャルログイン

2. **Clerk-Supabase連携**
   - ✅ セッショントークン認証（従来のJWTテンプレート方式から移行）
     - 2025年4月1日より、JWTテンプレート方式は公式に非推奨化
   - ✅ ClerkダッシュボードのConnect with Supabase機能を使用
   - ✅ Supabaseダッシュボードでのサードパーティ認証設定
   - ✅ Server Actionsでの認証フロー
   - ✅ 型安全なセッション管理
   - ✅ Supabase RLS (Row Level Security)
   - ✅ クライアントサイドでのSupabase認証状態同期

3. **認可**
   - ✅ ロールベースアクセス制御
   - ✅ ポリシーベースのデータアクセス
   - ✅ 機能フラグによる機能の有効化/無効化
   - ✅ ミドルウェアによるルート保護

### エラーハンドリングパターン
1. **Next.js エラーハンドリング**
   - `error.tsx` - ルート別エラーUI
   - `not-found.tsx` - 404カスタム表示
   - `global-error.tsx` - グローバルエラー
   - React Error Boundaryの活用

2. **カスタムエラークラス**
   - ✅ `ApiError`, `ValidationError`, `AuthenticationError`など
   - ✅ エラータイプ、コード、メッセージを含む
   - ✅ スタックトレース保持
   - ✅ 追加メタデータサポート

3. **Try/Catchとサーバーアクション**
   - ✅ サーバーアクション内でのエラーキャプチャ
   - ✅ クライアント側へのエラー伝播
   - ✅ 自動リトライメカニズム
   - ✅ タイムアウト処理

## データベース設計パターン

### スキーマ設計
1. **正規化**
   - 3NF（第三正規形）までのデータ正規化
   - 外部キー制約
   - カスケード更新/削除

2. **インデックス戦略**
   - 検索/フィルタリングフィールドへのインデックス付与
   - 複合インデックス
   - パフォーマンス最適化

3. **テーブル設計パターン**
   - `created_at`, `updated_at` タイムスタンプ
   - 論理削除（ソフトデリート）
   - バージョン履歴

4. **レビュー関連スキーマ**
   - `reviews` テーブル - レビューデータ
   - `review_tags` テーブル - レビュータグ管理
   - `review_images` テーブル - レビュー画像管理
   - `review_reactions` テーブル - 役に立った/いいね等のリアクション

### RLS（Row Level Security）パターン
1. **ユーザーベースのアクセス制御**
   - ユーザーIDに基づくデータフィルタリング
   - ロールベースの権限制御

2. **複雑なポリシー**
   - 複数条件を組み合わせたアクセス制御
   - 時間ベースのアクセス制限
   - 関係ベースのポリシー

## 統合パターン

### API設計パターン
1. **RESTful設計**
   - 資源指向のURLパス
   - HTTPメソッドの適切な使用
   - ステータスコードの一貫した使用

2. **レスポンス構造**
   - 標準化されたレスポンス形式
   - メタデータとペイロードの分離
   - エラー情報の一貫した形式

### 外部サービス統合
1. **SDKベースの統合**
   - ✅ PayPal SDK (@paypal/react-paypal-js)
   - ✅ Clerk SDK

2. **Server Actions活用**
   - ✅ サーバー側で安全なAPI呼び出し
   - ✅ APIキーの保護
   - ✅ エラーハンドリングとリトライ

3. **ウェブフック処理**
   - ✅ APIルートを使用したウェブフック受信
   - ✅ イベント検証と処理
   - ✅ 非同期処理と応答分離

### PayPal統合パターン
1. **PayPal SDKラッパー**
   - ✅ 公式React SDK適用
   - ✅ コンポーネント抽象化
   - ✅ 設定の一元管理

2. **セッション管理最適化**
   - ✅ サンドボックス環境問題対策
   - ✅ ストレージクリーンアップ
   - ✅ クッキー管理の改善

3. **決済フロー実装**
   - ✅ Server Actionsを使用した安全な処理
   - ✅ トランザクション管理
   - ✅ エラー処理と再試行

4. **診断ツール**
   - ✅ サンドボックスデバッガー
   - ✅ トラブルシューティング支援
   - ✅ 状態監視と診断

5. **国際化対応**
   - ✅ 多通貨サポート
   - ✅ ロケール別表示
   - ✅ 金額フォーマット

## 機能別パターン

### レビューシステム
1. **レビュー表示パターン**
   - ✅ ページネーション付きリスト表示
   - ✅ フィルタリングとソート機能
   - ✅ 星評価と視覚的表現
   - ✅ タグによるカテゴリ分類

2. **レビュー投稿フロー**
   - ✅ 多ステップフォームデザイン
   - クライアントサイドバリデーション
   - 画像アップロードプレビュー
   - Server Actionsによる処理（実装予定）

3. **レビュー管理**
   - モデレーションワークフロー（予定）
   - 不適切なコンテンツフラグ（予定）
   - 管理者承認フロー（予定）
   - パフォーマンス最適化（画像の遅延読み込みなど）

### サービス紹介
1. **情報アーキテクチャ**
   - ✅ セクション分割による情報の階層化
   - ✅ 視覚的要素による情報強調
   - ✅ アイコンと説明テキストの組み合わせ
   - ✅ ステップバイステップの利用ガイド

2. **FAQ実装**
   - ✅ 質問と回答の明確な分離
   - ✅ 視覚的な区切り
   - ✅ スキャン可能なレイアウト
   - 将来的な拡張性の確保

3. **特徴セクション設計**
   - ✅ 視覚的アイコンとテキストの組み合わせ
   - ✅ グリッドレイアウトによる整理
   - ✅ モバイル対応のレスポンシブデザイン
   - ✅ 各特徴の簡潔な説明

## 開発環境パターン

### 開発サーバー構成
1. **Next.js Development Server**
   - HMR (Hot Module Replacement)
   - ファストリフレッシュ
   - 開発者ツール
   - エラーオーバーレイ

2. **Turbopack活用**
   - 高速開発サーバー
   - メモリ使用量最適化
   - インクリメンタルビルド
   - タイプセーフなHMR

### 環境変数管理
1. **環境別の設定**
   - 開発、テスト、本番環境の分離
   - `.env.local`, `.env.development`, `.env.production`

2. **型安全な環境変数**
   - 型定義によるIntelliSense対応
   - 検証によるエラー早期発見

## セキュリティパターン

### 認証・認可
1. **Clerk認証ベストプラクティス**
   - ✅ セッショントークン方式（より効率的でセキュアなアプローチ）
     - 2025年4月1日よりSupabase公式に推奨
     - 従来のJWTテンプレート方式は2026年1月まではサポート継続
   - ✅ 古いJWT方式の完全廃止
   - ✅ 多要素認証対応
   - ✅ ソーシャルログイン

2. **トークン管理**
   - ✅ セキュアなトークン保存
   - ✅ トークン有効期限とリフレッシュロジック
   - ✅ トークンのセキュアな伝送
   - ✅ 自動トークン更新メカニズム
   - ✅ トークンキャッシュとパフォーマンス最適化

### データ保護
1. **入力検証**
   - サーバーサイドとクライアントサイドの両方でのバリデーション
   - Server Actionsでの検証
   - Zodによる型安全なバリデーション
   - XSS対策のためのHTMLエスケープ

2. **HTTPセキュリティヘッダー**
   - CSP (Content Security Policy)
     - ✅ Next.js設定による実装
     - ✅ 最適化されたドメイン設定
     - ✅ PayPal SDKの完全対応
     - ✅ Clerk認証対応
     - ✅ Web Workerとblobスキームの適切な設定
   - HSTS (HTTP Strict Transport Security)
   - Middlewareによるセキュリティヘッダー適用

3. **決済セキュリティ**
   - ✅ Server Actionsでの安全な処理
   - ✅ 決済トランザクションの整合性確保
   - ✅ エラー耐性とリトライメカニズム
   - ✅ セッション管理の最適化

## デザインパターン

### クライアントサイド
1. **カスタムフック**
   - 再利用可能なロジックのカプセル化
   - 例: `useAuth`, `useReservation`, `usePayment`

2. **コンポーネント合成**
   - 小さな単一責任コンポーネントの組み合わせ
   - プロップによる設定とカスタマイズ
   - 例: `<Form><FormField><Input /></FormField></Form>`

3. **コンテキストプロバイダー**
   - アプリケーション状態の共有
   - 例: `<ThemeProvider>`, `<AuthProvider>`

4. **フォームパターン**
   - ステップ形式のフォームデザイン
   - インラインバリデーション
   - フィードバック表示
   - 送信状態の管理

### サーバーサイド
1. **Server Action Handlers**
   - フォーム処理とデータミューテーション
   - 入力検証と型安全性
   - エラーハンドリングと結果返却

2. **Route Handlers**
   - APIエンドポイント実装
   - リクエスト処理とレスポンス生成
   - ミドルウェア適用

3. **サービスパターン**
   - ビジネスロジックのカプセル化
   - 再利用可能なデータ操作関数
   - Server ComponentとServer Actionsからの呼び出し

## テストパターン

### フロントエンドテスト
1. **コンポーネントテスト**
   - Vitest + Testing Libraryを使用
   - ユーザーインタラクションのシミュレーション
   - アクセシビリティテスト

2. **統合テスト**
   - ページレベルのテスト
   - 複数コンポーネントの連携テスト

3. **E2Eテスト**
   - Playwrightによるブラウザ自動化
   - ユーザーフローの完全なテスト
   - マルチブラウザテスト

### バックエンドテスト
1. **単体テスト**
   - サービスとヘルパー関数のテスト
   - モックとスタブの使用

2. **APIテスト**
   - エンドポイントの機能テスト
   - リクエスト/レスポンスの検証

3. **データベーステスト**
   - クエリとデータ操作のテスト
   - トランザクションのテスト

## デプロイメントパターン

1. **ビルドプロセス**
   - Next.js buildによる最適化ビルド
   - 環境変数の挿入
   - アセット最適化

2. **デプロイ戦略**
   - Vercel連携によるCI/CD（推奨）
   - GitHub Actions自動デプロイ
   - 環境別の設定と検証

## レスポンシブデザインパターン

### モバイルナビゲーション

1. **ハンバーガーメニュー**: 
   - モバイル表示時にメインナビゲーションを隠し、ハンバーガーアイコンを表示
   - クリック/タップでサイドバーメニューを表示
   - オーバーレイによるフォーカス管理

2. **サイドバーメニュー**:
   - 画面左からスライドインするアニメーション
   - ユーザー情報とナビゲーションリンクの表示
   - 閉じるアクションはオーバーレイクリックまたは専用ボタン

3. **適応的なレイアウト**:
   - ブレイクポイント: モバイル（〜767px）、タブレット（768px〜1023px）、デスクトップ（1024px〜）
   - フレックスボックスとグリッドによるレイアウト制御
   - 要素の順序変更と適応的な可視性

4. **パフォーマンス最適化**:
   - 条件付きレンダリングによる不要なコンポーネントのスキップ
   - アニメーションの最適化（CSS transition優先、必要な場合のみframer-motion）
   - タッチイベントの最適化

## 予約システムパターン

1. **多段階予約フォーム**:
   - ステップバイステップのフォーム進行
   - 各ステップでのバリデーション
   - 状態保持と戻る機能

2. **空き状況表示**:
   - カレンダービューでの空き状況
   - タイムスロット選択
   - リアルタイム更新

3. **予約確認フロー**:
   - 確認ページ
   - メール通知
   - キャンセル／変更オプション

## レビューシステムパターン

1. **レビューリスト**:
   - ページネーション（無限スクロールオプション）
   - フィルタリング（評価、日付、キーワード）
   - ソートオプション

2. **レビュー投稿フォーム**:
   - 多段階フォーム（基本情報、詳細、写真）
   - プレビュー機能
   - 下書き保存

3. **レビューモデレーション**:
   - 自動フィルタリング
   - 管理者承認フロー
   - 報告システム

## データベーススキーマ

### 主要テーブル

1. **restaurants**: レストラン情報
   - id: UUID (PK)
   - name: TEXT
   - description: TEXT
   - address: TEXT
   - contact: JSONB
   - hours: JSONB
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP

2. **reservations**: 予約情報
   - id: UUID (PK)
   - restaurant_id: UUID (FK)
   - user_id: UUID (FK)
   - date: DATE
   - time: TIME
   - party_size: INT
   - status: ENUM
   - notes: TEXT
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP

3. **users**: ユーザー情報
   - id: UUID (PK)
   - clerk_id: TEXT
   - email: TEXT
   - name: TEXT
   - profile: JSONB
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP

4. **reviews**: レビュー情報
   - id: UUID (PK)
   - restaurant_id: UUID (FK)
   - user_id: UUID (FK)
   - rating: INT
   - content: TEXT
   - visit_date: DATE
   - status: ENUM
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP

5. **review_tags**: レビュータグ
   - id: UUID (PK)
   - name: TEXT
   - category: TEXT

6. **review_images**: レビュー画像
   - id: UUID (PK)
   - review_id: UUID (FK)
   - url: TEXT
   - created_at: TIMESTAMP

7. **review_reactions**: レビューへのリアクション
   - id: UUID (PK)
   - review_id: UUID (FK)
   - user_id: UUID (FK)
   - type: ENUM
   - created_at: TIMESTAMP

### リレーションシップ

- restaurants 1:N reservations
- users 1:N reservations
- restaurants 1:N reviews
- users 1:N reviews
- reviews 1:N review_images
- reviews N:M review_tags
- reviews 1:N review_reactions

## セキュリティパターン

### 認証

1. **Clerk認証**:
   - JWT/セッションベース認証
   - ソーシャルログイン連携
   - 多要素認証オプション

2. **Supabase RLS (Row Level Security)**:
   - ユーザーごとのデータアクセス制限
   - ロールベースのセキュリティ
   - JWT検証

### データ保護

1. **入力バリデーション**:
   - サーバーサイドバリデーション
   - クライアントサイドバリデーション
   - 型安全性（TypeScript）

2. **APIセキュリティ**:
   - レート制限
   - CSRFトークン
   - セキュアヘッダー

## エラーハンドリングパターン

1. **グローバルエラーバウンダリ**:
   - アプリケーション全体のエラーキャッチ
   - フォールバックUI

2. **フォームエラー**:
   - インラインバリデーションメッセージ
   - フォームレベルエラー表示
   - エラーフォーカス管理

3. **APIエラー**:
   - 構造化されたエラーレスポンス
   - 再試行メカニズム
   - オフライン対応

## テストパターン

1. **ユニットテスト**: ビジネスロジックと独立コンポーネント
2. **統合テスト**: コンポーネント間の相互作用
3. **E2Eテスト**: ユーザーフローの検証
4. **視覚回帰テスト**: UIコンポーネントの表示確認

## デプロイパターン

1. **CI/CD**:
   - GitHub Actionsによる自動ビルドとテスト
   - プルリクエストプレビュー
   - 自動デプロイ

2. **環境分離**:
   - 開発環境
   - ステージング環境
   - 本番環境

3. **モニタリング**:
   - エラートラッキング
   - パフォーマンスモニタリング
   - ユーザー行動分析 